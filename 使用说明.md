# ComfyUI_Geemay_Tools 使用指南（动态联动版）

## 📁 项目结构

```
ComfyUI_Geemay_Tools/
├── __init__.py                    # 插件入口文件（包含web目录配置）
├── README.md                      # 项目说明文档
├── prompts_data.py               # 提示词数据库
├── 使用说明.md                    # 本文件
├── nodes/
│   ├── __init__.py               # nodes包初始化文件
│   └── geemay_preset_manager.py  # 核心节点文件（后端逻辑）
└── web/
    └── geemay_preset_manager.js  # 前端JavaScript扩展（动态联动）
```

## 🚀 安装步骤

1. **确认位置**：确保整个 `ComfyUI_Geemay_Tools` 文件夹位于：
   ```
   ComfyUI/custom_nodes/ComfyUI_Geemay_Tools/
   ```

2. **重启ComfyUI**：完全关闭并重新启动ComfyUI（必须完全重启才能加载前端扩展）

3. **查找节点**：在ComfyUI的节点菜单中，找到 `Geemay Tools` 分类

## ✨ 核心功能 - 动态联动

### 🎯 主要特性
- ✅ **智能联动**：当你选择不同的"预设主类"时，"功能类"下拉菜单会自动更新对应的选项
- ✅ **前端驱动**：使用JavaScript前端扩展实现实时响应，无需重新加载节点
- ✅ **后端验证**：Python后端会验证功能类是否匹配主类，确保数据正确性

### 🔄 动态联动工作原理

```
用户选择主类 → 前端JavaScript监听变化 → 自动更新功能类选项 → 用户选择功能类 → 后端验证 → 输出提示词
```

## 📖 使用方法

### 步骤1：添加节点
在ComfyUI工作流中右键 → Add Node → Geemay Tools → Geemay Preset Manager

### 步骤2：选择预设主类
从"main_category"下拉菜单中选择：
- 🏠 **室内专项**
- 🌳 **景观专项**
- 🏢 **建筑专项**
- 🔮 **GM未来分析**

**重要**：当你切换主类时，功能类下拉菜单会立即自动更新！

### 步骤3：选择功能类
根据主类，"function_category"会自动显示对应的功能选项：

#### 🏠 室内专项 → 功能类自动变为：
- 智能家居
- 空间动线
- 硬装材料
- 软装配饰
- 一键转夜景
- 添加人物

#### 🌳 景观专项 → 功能类自动变为：
- 植物分析
- 植物季像变化
- 转夜景
- 总平转鸟瞰
- 四季转变
- 天气转变
- 添加人物
- 景观动线

#### 🏢 建筑专项 → 功能类自动变为：
- 鸟瞰交通分析
- 建筑日照条件分析

#### 🔮 GM未来分析 → 功能类自动变为：
- 室内风水分析
- 庭院风水分析

### 步骤4：选择模版
从"template"下拉菜单中选择：
- 模版一
- 模版二
- 模版三
- 模版四

每个功能类的每个模版都有独特的提示词内容。

### 步骤5：连接输出
将节点的"prompt"输出端连接到你的文生图节点（如CLIP Text Encode）

### 步骤6：运行
点击"Queue Prompt"运行工作流，节点会输出对应的提示词

## 💡 使用示例

### 示例1：室内智能家居效果图
1. main_category: **室内专项**
2. function_category: 智能家居（自动显示）
3. template: 模版一
4. 输出：`smart home interior, modern IoT devices, intelligent lighting system...`

### 示例2：景观植物分析
1. main_category: **景观专项** ← 切换到这里
2. function_category: 植物分析（**自动更新为景观专项的选项**）
3. template: 模版二
4. 输出：`vegetation study, plant distribution map, ecological zones...`

### 示例3：建筑日照分析
1. main_category: **建筑专项** ← 切换到这里
2. function_category: 建筑日照条件分析（**自动更新为建筑专项的选项**）
3. template: 模版三
4. 输出：`building sun exposure study, solar radiation analysis...`

### 示例4：风水分析
1. main_category: **GM未来分析** ← 切换到这里
2. function_category: 室内风水分析（**自动更新为GM未来分析的选项**）
3. template: 模版一
4. 输出：`interior feng shui analysis, energy flow diagram...`

## 🔧 技术实现说明

### 前端部分（web/geemay_preset_manager.js）
- 使用ComfyUI的扩展API注册节点扩展
- 监听主类widget的变化事件
- 根据映射关系动态更新功能类widget的选项
- 自动切换到新列表的第一个选项

### 后端部分（nodes/geemay_preset_manager.py）
- 初始化时提供所有可能的功能类选项
- 执行时验证功能类是否属于当前主类
- 如果不匹配，自动切换到正确的功能类
- 从数据库获取并返回对应的提示词

### 数据库部分（prompts_data.py）
- 存储72个专业提示词预设
- 提供查询接口
- 支持主类、功能类、模版的三级查询

## 🔍 调试信息

如果你想查看动态联动是否正常工作，可以：

1. **打开浏览器控制台**（F12）
2. **切换主类**
3. **查看控制台输出**，应该会看到类似：
   ```
   Geemay: 主类切换到 "景观专项"，功能类更新为: ["植物分析", "植物季像变化", ...]
   ```

## ❓ 常见问题

### Q1: 节点没有出现在菜单中？
**A**: 
- 确认文件夹位置正确
- 检查是否完全重启了ComfyUI
- 查看ComfyUI控制台是否有错误信息

### Q2: 功能类没有自动更新？
**A**: 
- 确认 `web/geemay_preset_manager.js` 文件存在
- 确认 `__init__.py` 中有 `WEB_DIRECTORY` 配置
- 完全重启ComfyUI（必须重启才能加载前端扩展）
- 打开浏览器控制台（F12）查看是否有JavaScript错误

### Q3: 提示词输出为"Error: 未找到对应的提示词"？
**A**: 
- 检查选择的主类、功能类和模版组合是否正确
- 确认 `prompts_data.py` 文件完整无损
- 查看ComfyUI控制台是否有警告信息

### Q4: 如何添加新的主类或功能类？
**A**: 
1. 编辑 `prompts_data.py`，在 `PROMPTS_DATABASE` 中添加新条目
2. 编辑 `web/geemay_preset_manager.js`，在 `CATEGORY_MAPPING` 中添加对应映射
3. 保持两个文件的数据结构一致
4. 重启ComfyUI

### Q5: 可以同时使用多个节点吗？
**A**: 
可以！你可以在同一个工作流中添加多个Geemay Preset Manager节点，每个节点独立工作，互不干扰。

## 📝 技术说明

### 节点输入
- `main_category` (STRING): 预设主类选择
- `function_category` (STRING): 功能类选择（动态更新）
- `template` (STRING): 模版选择

### 节点输出
- `prompt` (STRING): 生成的提示词文本

### 数据流程
```
前端：用户选择主类 → JavaScript监听 → 更新功能类选项
后端：接收参数 → 验证匹配 → 查询数据库 → 返回提示词
```

## 🎨 提示词特点

所有提示词都经过精心设计，包含：
- ✅ 专业的建筑/室内/景观术语
- ✅ 高质量渲染关键词（8k, photorealistic, ultra detailed等）
- ✅ 场景氛围描述
- ✅ 技术细节说明
- ✅ 符合AI绘图模型的提示词格式

## 🔄 更新日志

### v1.1.0 (2026-01-29) - 动态联动版
- ✨ 新增前端JavaScript扩展
- 🔄 实现主类和功能类的动态联动
- 🛡️ 添加后端验证机制
- 📝 完善使用文档

### v1.0.0 (2026-01-29)
- ✨ 初始版本发布
- 🏠 支持室内专项（6个功能类）
- 🌳 支持景观专项（8个功能类）
- 🏢 支持建筑专项（2个功能类）
- 🔮 支持GM未来分析（2个功能类）
- 📦 每个功能类包含4个预设模版
- 💾 总计72个专业提示词预设

## 🎯 重要提示

1. **必须完全重启ComfyUI**：前端扩展只在启动时加载，修改后必须重启
2. **浏览器缓存**：如果修改了JavaScript文件，可能需要清除浏览器缓存（Ctrl+F5）
3. **控制台调试**：遇到问题时，打开浏览器控制台（F12）查看错误信息

---

**祝你使用愉快！🎉**

如有问题，请检查：
1. 文件结构是否完整
2. ComfyUI是否完全重启
3. 浏览器控制台是否有错误
4. ComfyUI控制台是否有警告
